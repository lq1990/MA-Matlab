% 关于采样频率
% 原始是 100hz，下采样后是10hz。下采样方法：直接每隔一小段取一个数值。
% 不同采样频率，t_end不同。应微调 idx_t_begin t_end 以确保 汽车启动时FP是0 且启动结束也是0.
% 上采样时，一定要注意：sync_t 的extend，不能是重复前一个t。

clc; close all; clear;

addpath(genpath(pwd));

%% 1. 先运行 dataStruct.m，从 mat -> table , Arr
% 数据被过滤，下采样，按照场景时间做clip
sampling_factor = 100 ; % 上采样 100hz
dataStruct(sampling_factor); 

% 会 save dataS, dataSArr。

%% 2. 从dataSArr 中找到每一列(即每一个signal)的最大值、最小值
load('.\DataFinalSave\dataSArr.mat');
load('.\src\signalTable.mat');
[signalsMaxMinStruct] = findSignalsMaxMin(dataSArr, signalTable);
% 存储，为了test时也要用到
save '.\DataFinalSave\signalsMaxMinStruct' signalsMaxMinStruct

%% 3. scaling
[dataSScaling, dataSArrScaling]=scaling( dataSArr, signalsMaxMinStruct, signalTable );
save '.\DataFinalSave\dataSScaling' dataSScaling
save '.\DataFinalSave\dataSArrScaling' dataSArrScaling

%% 4. plot
plotscaling = 1;
range_id = [1:19]; % total_id: 19
range_signal = [1:5]; % total_signal: 17

if plotscaling==1
    load('.\DataFinalSave\dataSArrScaling.mat');
    load('.\src\signalTable.mat');
    mp = MyPlot(dataSArrScaling, signalTable, range_id , range_signal ); 
    mp.show();
else
    load('.\DataFinalSave\dataSArr.mat');
    load('.\src\signalTable.mat');
    mp = MyPlot(dataSArr, signalTable, range_id , range_signal  ); 
    mp.show();
end

clearvars mp plotscaling range_id range_signal sampling_factor;


%% Correlation Coefficient , PCA
% 将所有场景中所有信号的时序数据 放到一个matrix中
load('dataSArr');
load('signalTable.mat');

allMatData = zeros(1, length(signalTable.signalName));

for i = 1:length(dataSArr) % 遍历每个场景
     aMatData= [];
     for j = 1: height(signalTable) % 遍历每个signal
         signalName_cell = signalTable.signalName(j); signalName = signalName_cell{1,1};
         
         a_scenario_signal_data = dataSArr(i).(signalName);
         aMatData(:, j) = a_scenario_signal_data;
     end
     allMatData = vertcat(allMatData, aMatData);
end
allMatData = allMatData(2:end, :); % 把第一行去除
clearvars i j aMatData signalName_cell signalName a_scenario_signal_data;

% ========== normalization, (data-mean) ./ std, let mean=0 & var=1 ======================
data_mean = repmat(mean(allMatData), length(allMatData),1 );
data_std = repmat(std(allMatData), length(allMatData),1 );

allMatData = (allMatData - data_mean) ./ (data_std+1e-8); % avoid num/0

% covariance, over cols
var_data = var(allMatData);
cov_data = cov(allMatData); % equivalent to Correlation Coefficient because of normaliation

% figure;
% showMatrix('var', var_data, 0);
figure;
showMatrix('cov', cov_data, 0);

% ================= PCA ===============================
[ev, lambda] = eig(cov_data);

figure;
showMatrix('lambda', lambda, 0);

figure;
showMatrix('eigenvector', ev, 0);

